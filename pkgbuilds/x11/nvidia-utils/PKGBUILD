# Contributor: Jens Pranaitis <jens@jenux.homelinux.org>
# Contributor: Thomas Baechler <thomas@archlinux.org>
# Contributor: James Rayner <iphitus@gmail.com>
pkgbase=nvidia
pkgname=("nvidia-utils" "nvidia-drivers")
pkgver=180.60
pkgrel=4
pkgdesc="NVIDIA drivers utilities and libraries."
arch=('i686')
[ "$CARCH" = "i686"   ] && ARCH=x86 	 
url="http://www.nvidia.com/"
license=('custom')
install=nvidia.install
source=(http://download.nvidia.com/XFree86/Linux-${ARCH}/${pkgver}/NVIDIA-Linux-${ARCH}-${pkgver}-pkg0.run nvidia-symlinks.sh)
md5sums=('84fb2ac671804f94544237b11a63ba31'
         '3bb95abce03c863f0afa41d1c3144d21')
options=(docs !strip)
build()
{
  # override nvida install routine and do it the long way.
  cd ${srcdir}/
  sh NVIDIA-Linux-${ARCH}-${pkgver}-pkg0.run --extract-only
}
package_nvidia-drivers() {
depends=("xorg-server" "gcc-libs" "zlib" "libxext")
provides=("libgl")
  cd "${srcdir}"/NVIDIA-Linux-${ARCH}-${pkgver}-pkg0/usr
  mkdir -p ${pkgdir}/usr/lib/nvidia/modules/{extensions,drivers}
  mkdir -p ${pkgdir}/usr/share/licenses/nvidia/
  mkdir -p $pkgdir/usr/include/{cuda,vdpau}
  install -m644 include/cuda/cuda*.h $pkgdir/usr/include/cuda
  install -m644 include/vdpau/vdpau*.h $pkgdir/usr/include/vdpau
  install lib/{libGLcore,libGL,libnvidia-cfg,libcuda,tls/libnvidia-tls}.so.${pkgver} \
       ${pkgdir}/usr/lib/nvidia/ || return 1
  install X11R6/lib/libXv* ${pkgdir}/usr/lib/nvidia/ || return 1
  install X11R6/lib/modules/drivers/nvidia_drv.so ${pkgdir}/usr/lib/nvidia/modules/drivers || return 1
  install X11R6/lib/modules/extensions/libglx.so.$pkgver ${pkgdir}/usr/lib/nvidia/modules/extensions || return 1
  cd ${pkgdir}/usr/lib/nvidia/
  ln -s libGL.so.$pkgver libGL.so || return 1
  ln -s libGL.so.$pkgver libGL.so.1 || return 1
  ln -s libGLcore.so.$pkgver libGLcore.so.1 || return 1
  ln -s libnvidia-cfg.so.$pkgver libnvidia-cfg.so.1 || return 1
  ln -s libnvidia-tls.so.$pkgver libnvidia-tls.so.1 || return 1
  ln -s libcuda.so.$pkgver libcuda.so.1 || return 1
  ln -s libcuda.so.$pkgver libcuda.so || return 1
  ln -s libXvMCNVIDIA.so.$pkgver libXvMCNVIDIA_dynamic.so.1 || return 1
  cd ${pkgdir}/usr/lib/nvidia/modules/extensions
  ln -s libglx.so.$pkgver libglx.so || return 1
  install -m644 ${srcdir}/NVIDIA-Linux-${ARCH}-${pkgver}-pkg0/LICENSE ${pkgdir}/usr/share/licenses/nvidia/ || return 1
  find ${pkgdir}/usr -type d -exec chmod 755 {} \;
  install -D -m644 "${srcdir}"/nvidia-symlinks.sh "${pkgdir}"/usr/share/select-opengl/functions/nvidia-symlinks.sh
  # phew :)
}
package_nvidia-utils() {
conflicts=("nvidia-173xx-utils")
depends=("gtk2")
  cd "${srcdir}"/NVIDIA-Linux-${ARCH}-${pkgver}-pkg0/usr
  mkdir -p "${pkgdir}"/usr/{bin,share/applications,share/man/man1,share/pixmaps/}
  install -m755 bin/nvidia-{settings,xconfig,bug-report.sh} $pkgdir/usr/bin/ || return 1
  install -m644 share/applications/nvidia-settings.desktop $pkgdir/usr/share/applications/ || return 1
  sed -e 's:__UTILS_PATH__:/usr/bin:' -e 's:__PIXMAP_PATH__:/usr/share/pixmaps:' -i $pkgdir/usr/share/applications/nvidia-settings.desktop
  install -m644 share/pixmaps/nvidia-settings.png $pkgdir/usr/share/pixmaps/ || return 1
  install -m644 share/man/man1/* $pkgdir/usr/share/man/man1/ || return 1
  rm $pkgdir/usr/share/man/man1/nvidia-installer.1.gz || return 1
}
